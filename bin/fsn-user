#!/usr/bin/env zsh
set -euo pipefail
APP_ROOT="${0:a:h:h}"
source "$APP_ROOT/lib/common.zsh"
require_sqlite

cmd="${1:-help}"; shift || true

case "$cmd" in
  add)
    local name="$1" email="$2" phone="$3" city="$4"
    require_arg "$name" name; require_arg "$email" email
    require_arg "$phone" phone; require_arg "$city" city
    valid_phone "$phone" || { log_err "Invalid phone (expected +234XXXXXXXXXX)"; exit 1; }
    name=$(sql_escape "$name"); email=$(sql_escape "$email"); phone=$(sql_escape "$phone"); city=$(sql_escape "$city")
    sqlite3 "$FSN_DB" "INSERT INTO users (name,email,phone,city) VALUES ('$name','$email','$phone','$city');"
    sqlite3 "$FSN_DB" "INSERT INTO audit_log (action,entity,detail) VALUES ('create','users','$name ($email)');"
    log_ok "User $name added"
    ;;
  list)
    sqlite3 "$FSN_DB" -header -column "SELECT id,name,email,phone,city,created_at FROM users;"
    ;;
  *)
    echo "Usage: flatshareNaija user add <name> <email> <phone> <city>"
    echo "       flatshareNaija user list"
    ;;
esac
