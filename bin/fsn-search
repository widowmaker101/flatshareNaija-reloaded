#!/usr/bin/env zsh
set -euo pipefail
APP_ROOT="${0:a:h:h}"
source "$APP_ROOT/lib/common.zsh"
require_sqlite
require_python

[[ $# -eq 0 ]] && { echo "Usage: flatshareNaija search \"<query>\""; exit 1; }
query="$*"
parsed=$(python3 "$APP_ROOT/lib/nlp_search.py" "$query")

city=$(echo "$parsed" | sed -n "s/.*'city': '\([^']*\)'.*/\1/p")
area=$(echo "$parsed" | sed -n "s/.*'area': '\([^']*\)'.*/\1/p")
budget=$(echo "$parsed" | sed -n "s/.*'budget': \([0-9]*\).*/\1/p")

[[ -z "$budget" ]] && budget=1000000000
[[ -z "$city"   ]] && city="Abuja"
[[ -z "$area"   ]] && area="Wuse"

log_info "Search: city=$city area=$area budget=â‚¦$budget"
sqlite3 "$FSN_DB" -header -column \
  "SELECT id,title,city,area,rent,has_generator,has_inverter FROM listings WHERE city='$(sql_escape "$city")' AND area='$(sql_escape "$area")' AND rent <= $budget ORDER BY rent ASC" \
  | paginate 10
