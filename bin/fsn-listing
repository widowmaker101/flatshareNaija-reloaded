#!/usr/bin/env zsh
set -euo pipefail
APP_ROOT="${0:a:h:h}"
source "$APP_ROOT/lib/common.zsh"
source "$APP_ROOT/lib/moderation.zsh"
require_sqlite

cmd="${1:-help}"; shift || true

case "$cmd" in
  add)
    local title="$1" desc="$2" city="$3" area="$4" rent="$5" gen="${6:-0}" inv="${7:-0}"
    require_arg "$title" title; require_arg "$desc" desc
    require_arg "$city" city; require_arg "$area" area
    valid_money "$rent" || { log_err "Rent must be a positive integer"; exit 1; }
    [[ "$gen" =~ ^[01]$ ]] || gen=0; [[ "$inv" =~ ^[01]$ ]] || inv=0

    if ! moderate_listing "$desc"; then
      log_err "Listing rejected: $title"; exit 1
    fi

    title=$(sql_escape "$title"); desc=$(sql_escape "$desc"); city=$(sql_escape "$city"); area=$(sql_escape "$area")
    sqlite3 "$FSN_DB" "INSERT OR IGNORE INTO listings (title,description,city,area,rent,has_generator,has_inverter)
                       VALUES ('$title','$desc','$city','$area',$rent,$gen,$inv);"
    sqlite3 "$FSN_DB" "INSERT INTO audit_log (action,entity,detail) VALUES ('create','listings','$title in $city/$area');"
    log_ok "Listing added: $title"
    ;;
  search)
    local city="$1" area="$2" max="${3:-999999999}" page="${4:-10}"
    valid_money "$max" || { log_err "Max must be a positive integer"; exit 1; }
    city=$(sql_escape "$city"); area=$(sql_escape "$area")
    sqlite3 "$FSN_DB" -header -column \
      "SELECT id,title,city,area,rent,has_generator,has_inverter FROM listings WHERE city='$city' AND area='$area' AND rent <= $max ORDER BY rent ASC" \
      | paginate "$page"
    ;;
  *)
    echo "Usage: flatshareNaija listing add <title> <desc> <city> <area> <rent> [has_generator 0/1] [has_inverter 0/1]"
    echo "       flatshareNaija listing search <city> <area> <max> [page_size]"
    ;;
esac
