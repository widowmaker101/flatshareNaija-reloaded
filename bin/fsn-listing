#!/usr/bin/env zsh
set -euo pipefail
APP_ROOT="${0:a:h:h}"
db="$APP_ROOT/db/flatshare.db"
source "$APP_ROOT/lib/moderation.zsh"

cmd="${1:-help}"; shift || true

case "$cmd" in
  add)
    title="$1"; desc="$2"; city="$3"; area="$4"; rent="$5"
    if ! moderate_listing "$desc"; then
      echo "❌ Listing rejected: $title"
      exit 1
    fi
    sqlite3 "$db" "INSERT INTO listings (title,description,city,area,rent) VALUES ('$title','$desc','$city','$area',$rent);"
    echo "✅ Listing added: $title"
    ;;
  search)
    city="$1"; area="$2"; max="$3"
    sqlite3 "$db" "SELECT id,title,city,area,rent FROM listings WHERE city='$city' AND area='$area' AND rent <= $max;"
    ;;
  *)
    echo "Usage: flatshareNaija listing add <title> <desc> <city> <area> <rent>"
    echo "       flatshareNaija listing search <city> <area> <max>"
    ;;
esac
