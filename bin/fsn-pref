#!/usr/bin/env zsh
set -euo pipefail
APP_ROOT="${0:a:h:h}"
source "$APP_ROOT/lib/common.zsh"
require_sqlite

cmd="${1:-help}"; shift || true

case "$cmd" in
  set)
    local user="$1" budget="$2" city="$3" area="$4" lifestyle="${5:-}"
    require_arg "$user" user; require_arg "$budget" budget
    valid_money "$budget" || { log_err "Budget must be a positive integer"; exit 1; }
    uid=$(sqlite3 "$FSN_DB" "SELECT id FROM users WHERE name='$(sql_escape "$user")';")
    [[ -n "$uid" ]] || { log_err "User not found: $user"; exit 1; }
    city=$(sql_escape "$city"); area=$(sql_escape "$area"); lifestyle=$(sql_escape "$lifestyle")
    sqlite3 "$FSN_DB" "INSERT INTO preferences (user_id,budget,city,area,lifestyle) VALUES ($uid,$budget,'$city','$area','$lifestyle');"
    sqlite3 "$FSN_DB" "INSERT INTO audit_log (action,entity,detail) VALUES ('create','preferences','for $user');"
    log_ok "Preferences set for $user"
    ;;
  list)
    sqlite3 "$FSN_DB" -header -column "SELECT * FROM preferences;"
    ;;
  *)
    echo "Usage: flatshareNaija pref set <user> <budget> <city> <area> <lifestyle>"
    ;;
esac
