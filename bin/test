#!/usr/bin/env zsh
set -euo pipefail
export PATH="$PWD/bin:$PATH"

flatshareNaija init
flatshareNaija user add "TestUser" "test@example.com" "+2348012345678" "Abuja"
flatshareNaija pref set "TestUser" 600000 Abuja Wuse remote

# Reset listings
sqlite3 db/flatshare.db "DELETE FROM listings;"

# Good listing
flatshareNaija listing add "Mini-flat Wuse" "Self-con, borehole, gen" Abuja Wuse 500000 1 0

# Bad listing rejected
if flatshareNaija listing add "Scam flat" "2 years upfront required" Abuja Wuse 400000; then
  echo "Moderation failed"; exit 1
else
  echo "Moderation OK"
fi

# Match scored
flatshareNaija match "TestUser" | grep -q "Score:" || { echo "No scored matches"; exit 1; }

# NLP search
flatshareNaija search "flat in Wuse under 600k with generator" >/dev/null || { echo "NLP search failed"; exit 1; }

# Export CSV
flatshareNaija export csv >/dev/null || { echo "Export failed"; exit 1; }

# Backup
flatshareNaija backup

echo "âœ… Smoke tests passed"
