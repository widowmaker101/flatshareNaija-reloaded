#!/usr/bin/env zsh
set -euo pipefail
export PATH="$PWD/bin:$PATH"

flatshareNaija init
flatshareNaija user add "TestUser" "test@example.com" "+2348012345678" "Abuja"
flatshareNaija pref set "TestUser" 600000 Abuja Wuse remote

# Clean slate and seed
sqlite3 db/flatshare.db "DELETE FROM listings;"
flatshareNaija seed

echo "-- Moderation rejection expected:"
if flatshareNaija listing add "Scam flat" "2 years upfront required" Abuja Wuse 400000; then
  echo "Moderation failed (should reject)"; exit 1
else
  echo "Moderation passed (rejected scam)"
fi

echo "-- Matching:"
flatshareNaija match "TestUser" | grep -q "Score:" || { echo "No scored matches"; exit 1; }

echo "-- NLP search:"
flatshareNaija search "flat in Wuse under 600k with generator" >/dev/null || { echo "NLP search failed"; exit 1; }

echo "âœ… Smoke tests passed"
